#!/usr/bin/env ruby
# frozen_string_literal: true

require 'bundler/inline'

gemfile do
  source 'https://rubygems.org'
  gem 'tty'
end

require 'tty-box'
require 'tty-command'
require 'pastel'

cmd = TTY::Command.new(printer: :null)
pastel = Pastel.new

# --- 1. ãƒ˜ãƒƒãƒ€ãƒ¼è¡¨ç¤º ---
# ãƒ–ãƒ­ãƒƒã‚¯ã§ä¸­èº«ã‚’æ›¸ãã¤ã¤ã€è¿”ã‚Šå€¤ã‚’ print ã§å‡ºåŠ›ã—ã¾ã™
box = TTY::Box.frame(
  width: 50,
  height: 5,
  padding: 1,
  align: :center,
  title: { top_left: ' SUPPLEMENT ' },
  border: :thick,
  style: {
    fg: :cyan, # æ ç·šã®è‰²
    border: { fg: :cyan }
  }
) do
  'System Status Check'
end
print box

# --- 2. OSæ¤œå‡º ---
os_name = `uname -s`.strip
os_display = if os_name == 'Darwin'
               'macOS ğŸ'
             elsif File.exist?('/etc/arch-release')
               'Omarchy (Arch Linux) ğŸ§'
             else
               'Unknown OS â“'
             end

puts pastel.bold('Detected OS: ') + pastel.cyan(os_display)
puts

# --- 3. Git Status ç¢ºèª ---
begin
  cmd.run('git rev-parse --is-inside-work-tree')
  out, = cmd.run('git status --porcelain')

  if out.empty?
    puts pastel.green('âœ” No changes found. Working tree is clean.')
  else
    puts pastel.yellow('âš  Uncommitted changes detected:')
    puts

    out.each_line do |line|
      status_code = line[0..1]
      file = line[3..-1].strip

      # ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚³ãƒ¼ãƒ‰ã«å¿œã˜ãŸè‰²ä»˜ã‘
      colored_status = if status_code.include?('M')
                         pastel.yellow(status_code)
                       elsif status_code.include?('A')
                         pastel.green(status_code)
                       elsif status_code.include?('D')
                         pastel.red(status_code)
                       elsif status_code.include?('R')
                         pastel.blue(status_code)
                       elsif status_code.include?('?')
                         pastel.dim(status_code)
                       else
                         pastel.white(status_code)
                       end

      puts "  #{colored_status}  #{file}"
    end

    puts
    puts pastel.dim('To update, commit these changes or run make install.')
  end

rescue TTY::Command::ExitError
  puts pastel.red('Not a git repository.')
end
puts
