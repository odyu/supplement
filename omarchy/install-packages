#!/usr/bin/env ruby
# frozen_string_literal: true

# Arch/Omarchy å‘ã‘ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ©ãƒ¼ (Ruby + TTY UI)

require 'bundler/inline'

gemfile do
  source 'https://rubygems.org'
  gem 'tty'
end

require 'tty-command'
require 'tty-spinner'
require 'tty-box'
require 'pastel'
require 'tmpdir'
require 'fileutils'

def system!(*cmd)
  # ä¾‹å¤–ã‚’æŠ•ã’ã‚‹ system ãƒ©ãƒƒãƒ‘ãƒ¼ï¼ˆRuby 3.2+ï¼‰
  system(*cmd, exception: true)
end

pastel = Pastel.new

header = TTY::Box.frame(
  width: 60,
  height: 5,
  padding: 1,
  align: :center,
  title: { top_left: ' SUPPLEMENT ' },
  border: :thick,
  style: { fg: :cyan, border: { fg: :cyan } }
) { 'ðŸ“¦ Starting Package Installation...' }

puts header

# -----------------------------------------------------------------------------
# è¨­å®š: ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ãŸã„ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ãƒªã‚¹ãƒˆ
# -----------------------------------------------------------------------------

PACMAN_PACKAGES = %w[
  base-devel
  git
  stow
  unzip
  neovim
  zsh
].freeze

AUR_PACKAGES = %w[
  google-chrome
  bitwarden-bin
  jetbrains-toolbox
].freeze

spinner = TTY::Spinner.new('[:spinner] Installing Official Packages (pacman)...', format: :dots)
spinner.auto_spin
begin
  # --needed: æ—¢ã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ¸ˆã¿ãªã‚‰ã‚¹ã‚­ãƒƒãƒ— (å†ªç­‰æ€§ç¢ºä¿)
  system! 'sudo', 'pacman', '-S', '--noconfirm', '--needed', *PACMAN_PACKAGES
  spinner.success(pastel.green(' done'))
rescue => e
  spinner.error(pastel.red(' failed'))
  warn e.message
  exit 1
end

# yay ã®å­˜åœ¨ç¢ºèªã¨ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
spinner = TTY::Spinner.new('[:spinner] Checking AUR Helper (yay)...', format: :dots)
spinner.auto_spin
begin
  yay_exists = system('command -v yay >/dev/null 2>&1')
  if yay_exists
    spinner.success(pastel.green(' yay is already installed.'))
  else
    spinner.update(title: 'Installing yay (AUR helper)...')
    spinner.restart
    Dir.mktmpdir do |tmp|
      repo_dir = File.join(tmp, 'yay')
      system! 'git', 'clone', 'https://aur.archlinux.org/yay.git', repo_dir
      Dir.chdir(repo_dir) do
        system! 'makepkg', '-si', '--noconfirm'
      end
    end
    spinner.success(pastel.green(' yay installed successfully.'))
  end
rescue => e
  spinner.error(pastel.red(' failed'))
  warn e.message
  exit 1
end

# AUR ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
spinner = TTY::Spinner.new('[:spinner] Installing AUR Packages...', format: :dots)
spinner.auto_spin
begin
  system! 'yay', '-S', '--noconfirm', '--needed', *AUR_PACKAGES
  spinner.success(pastel.green(' done'))
rescue => e
  spinner.error(pastel.red(' failed'))
  warn e.message
  exit 1
end

footer = TTY::Box.frame(
  width: 60,
  height: 3,
  padding: 1,
  align: :center,
  border: :thick,
  style: { fg: :green, border: { fg: :green } }
) { 'âœ… All packages installation sequence completed.' }

puts footer

